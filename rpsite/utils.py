from django.conf import settings
from hashlib import sha256
import gmpy2
import time

def hashing(*args, **kwargs):
    i = 1
    for j in args:
        i *= j
    return int(sha256(str(i).encode()).hexdigest(), 16) % 731499577

def verify(pubkey, course_no, **kwargs):
    params = {key: int(kwargs[key]) for key in kwargs}
    grnym = int(sha256(course_no.encode()).hexdigest(), 16) % 731499577
    grnym = gmpy2.powmod(grnym, settings.RNYM_PARAM['exp'], settings.RNYM_PARAM['gamma'])
    if params['x'] != hashing(
        params['C'], params['Cv'], params['Ce'],
        params['Cs'], params['Cx'], params['Cz'],
        params['Cw'], pubkey['g'], pubkey['h']
    ):
        print(1)
        return False
    if gmpy2.powmod(params['Cv'], params['z1'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z2'], pubkey['n']) * \
        gmpy2.invert(params['y1'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['C'], params['x'], pubkey['n']):
        print(2)
        return False
    if gmpy2.powmod(pubkey['g'], params['z1'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z3'], pubkey['n']) * \
        gmpy2.invert(params['y2'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Ce'], params['x'], pubkey['n']):
        print(3)
        return False
    if gmpy2.powmod(pubkey['a'], params['z4'], pubkey['n']) * \
        gmpy2.powmod(pubkey['b'], params['z5'], pubkey['n']) * \
        gmpy2.powmod(pubkey['g'], params['z6'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z7'], pubkey['n']) * \
        gmpy2.invert(params['y3'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod((params['C'] * gmpy2.invert(pubkey['c'], pubkey['n'])), params['x'], pubkey['n']):
        print(4)
        return False
    if gmpy2.powmod(pubkey['g'], params['z4'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z8'], pubkey['n']) * \
        gmpy2.invert(params['y4'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Cx'], params['x'], pubkey['n']):
        print(5)
        return False
    if gmpy2.powmod(pubkey['g'], params['z5'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z9'], pubkey['n']) * \
        gmpy2.invert(params['y5'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Cs'], params['x'], pubkey['n']):
        print(6)
        return False
    if gmpy2.powmod(pubkey['g'], params['z10'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z11'], pubkey['n']) * \
        gmpy2.invert(params['y6'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Ce'], params['x'], pubkey['n']):
        print(7)
        return False
    if gmpy2.powmod(pubkey['g'], params['z6'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z12'], pubkey['n']) * \
        gmpy2.invert(params['y7'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Cz'], params['x'], pubkey['n']):
        print(8)
        return False
    if gmpy2.powmod(params['Cv'], params['z10'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z7'], pubkey['n']) * \
        gmpy2.invert(params['y8'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['C'], params['x'], pubkey['n']):
        print(9)
        return False
    if gmpy2.powmod(grnym, params['z4'], settings.RNYM_PARAM['gamma']) * \
        gmpy2.invert(params['y13'], settings.RNYM_PARAM['gamma']) % settings.RNYM_PARAM['gamma'] != \
        gmpy2.powmod(params['rnym'], params['x'], settings.RNYM_PARAM['gamma']):
        print(10)
        return False
    if gmpy2.powmod(pubkey['g'], params['z13'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z14'], pubkey['n']) * \
        gmpy2.invert(params['y9'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Cz'], params['x'], pubkey['n']):
        print(11)
        return False
    if gmpy2.powmod(pubkey['g'], params['z15'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z16'], pubkey['n']) * \
        gmpy2.invert(params['y10'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Cw'], params['x'], pubkey['n']):
        print(12)
        return False
    if gmpy2.powmod(pubkey['g'], params['z17'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z18'], pubkey['n']) * \
        gmpy2.invert(params['y11'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Ce'], params['x'], pubkey['n']):
        print(13)
        return False
    if gmpy2.powmod(params['Cw'], params['z17'], pubkey['n']) * \
        gmpy2.powmod(pubkey['h'], params['z19'], pubkey['n']) * \
        gmpy2.invert(params['y12'], pubkey['n']) % pubkey['n'] != \
        gmpy2.powmod(params['Cz'], params['x'], pubkey['n']):
        print(13)
        return False

    return True
    
test_pubkey = {
    'n': 18717509941797749417560764574966600472289762943602848754869198820578124146918657201134197159188275162417414422759238325580689714427937920258764226207518380897665997171405626392300823010177425863144544450613967921140111163060255228808666273360541911904509534623858163772702253225019492377842486072039481359680339605245760904386669926769377678330105187603454518822793678376840008247317968745193123014594107629529824089170879003611241657851003447277900796685694008586440930240219128466592576132379592781137645445374737794913744581193136730986421299115067394849260282602280324554720954433874244897581740344102705954294773,
    'a': 10742020121563019072973206960325514766915559204496674092334048472015141742915749526448149296672454228311251994473442551239986137597051994941069901411926098868166228154244091068300395126573688240796281581345905937623716965335271054423914081099789495782747818574827710002614462677841298471090511773471646246600899797055996666797113119836120896408219155603622244037047894285739126298865838574698600322763301869433149488380644497194399504994199941378636789605178562220842963940611819003294018518221876946007798023896588041766283916122687480057860231205158454317207229538278300168942410280217607382126927594185557395264576,
    'b': 1959096525147109907897012904203676157550054228204893093017972645253168649715961291790137603113566638562338139123068553050088179458662077562423727084727325295265788965796590309582561824709011379607524380165010844025148544318482658236720507307452597683507533797367700830021384935037525655691067780141418239242353676851610368845759056403540634419777212640723932625812226481389290176639431015960623005427486136777458084799000913867190759817159349935830298989977857737406352077615343930559244553971751328299489056062895187694780418852773633145386001616378306193500059624762119849144011985126865607476170702540873289122500,
    'c': 12551879608620534894958840158495498136109896770154550499854918974555239116875194610362269987753023374563830794912291272013765800581052592798454634385388248231583069638529783657966708408345287293949469848464572536491977891184212883855620123105628206196354157550404926584972242938541211908092634589285590809011025377038365235207740647717408836230754503371680014138464860718760074835591122801726791770760771822052482178229962047844555367570434147068037927937913820797916151353127929734058898730165104475413052303572455883090283912716502480412033438545256869234322327509618735859311624261001481039456958824149936558605948,
    'g': 7004016561711896358056312767582760330186319192194853046572792282705718079170700546599311284656504038200582908109057193958000161675995541716215671778636662090476677556004767578567467602586677836471229722770450250248088861525407306618354321693630478216524486232635401393185194055479760464737092876826309154544546285851172523808683000219853051993561941755105333155048781736486593066241994579255164835244693251716399002318089470557385744064544360148273499396994712998668597395213372435224972983206210938665839167852482397778261816701050794605414493604265868493534758621760921263609683635516943976030893706156045596200656,
    'h': 7118882113527211428855348100615796718920244418147612729198192315602380571360613276729953891678031765394996236853965144554017093001739858409534017852129661504856716557006187621013028352219711656596632615704340446278303434740259044909298995128781401229439251908133389588222280291583190979363033269723318317332373779587255216761275513908032456302214180003823418167533952412675716328971844109709856992874715286655703184607639440152160556028587624637317867038201485728319493580567946990482273038439187158534057427656518190523368107317478365884232618455823449097342264095738690748746016756881784828485919390990743687096225
}
test_privkey = 128365365756530107805070739306611841775756883624489551948526868146604062550101939267098608537664501806243361408386069029891129886804565154487450666023218980002392655839948753174363892711108718422890469787767267263139787741144192899211590526467649902885558312501630257979423005188459393996419082228201362979807
